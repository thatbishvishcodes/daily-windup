<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Wind Up + Wind Down</title>

  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --lilac:#c9a7ff;
      --pink:#ff4fd8;
      --yellow:#ffe8a3;
      --bg:#fbf7ff;
      --text:#22112f;
      --muted:rgba(34,17,47,0.6);
      --card:rgba(255,255,255,0.92);
      --stroke:rgba(120,84,160,0.18);
      --radius:18px;
      --radius2:14px;
      --shadow:0 10px 30px rgba(40,18,60,0.10);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(201,167,255,0.35), transparent 55%),
        radial-gradient(1000px 500px at 90% 10%, rgba(255,79,216,0.14), transparent 55%),
        radial-gradient(900px 500px at 40% 95%, rgba(255,232,163,0.18), transparent 55%),
        linear-gradient(180deg, #fbf7ff, #f6efff);
      color:var(--text);
    }

    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(34,17,47,0.92);
      color:white;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 14px 30px rgba(0,0,0,0.20);
      z-index:1000;
      max-width:calc(100% - 32px);
      text-align:center;
      display:none;
    }

    .app{
      max-width:820px;
      margin:0 auto;
      padding:16px;
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    h1{
      font-family:"League Spartan", Inter, sans-serif;
      font-size:20px;
      margin:0;
    }

    .dateRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,79,216,0.28);
      background:rgba(255,79,216,0.08);
      color:rgba(34,17,47,0.85);
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }

    .headerRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }

    .sectionTitle{
      font-family:"League Spartan", Inter, sans-serif;
      font-size:18px;
      margin:0;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }

    .lead{
      margin:10px 0 14px;
      font-size:16px;
      font-weight:600;
    }

    .subTitle{
      font-family:"League Spartan", Inter, sans-serif;
      font-size:16px;
      margin:14px 0 4px;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .chip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(201,167,255,0.55);
      background:rgba(201,167,255,0.12);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }

    .chip.active{
      background:rgba(255,79,216,0.12);
      border-color:rgba(255,79,216,0.55);
    }

    input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:var(--radius2);
      border:1px solid rgba(120,84,160,0.20);
      background:rgba(255,255,255,0.85);
      color:var(--text);
      outline:none;
      font:inherit;
      margin-top:6px;
    }

    textarea{
      min-height:88px;
      resize:vertical;
    }

    input:focus, textarea:focus{
      border-color:rgba(255,79,216,0.45);
      box-shadow:0 0 0 3px rgba(201,167,255,0.18);
    }

    input[disabled], textarea[disabled]{
      opacity:0.75;
      cursor:not-allowed;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      font-family:Inter, sans-serif;
    }

    .btnPrimary{
      background:rgba(255,79,216,0.16);
      border:1px solid rgba(255,79,216,0.35);
      color:rgba(34,17,47,0.95);
    }

    .btnGhost{
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(120,84,160,0.18);
      color:rgba(34,17,47,0.85);
    }

    .summary{
      border-top:1px solid rgba(120,84,160,0.12);
      margin-top:12px;
      padding-top:12px;
      display:grid;
      gap:10px;
    }

    .summaryBlock{
      padding:10px 12px;
      border-radius:var(--radius2);
      border:1px solid rgba(201,167,255,0.35);
      background:rgba(201,167,255,0.10);
    }

    .summaryTitle{
      font-family:"League Spartan", Inter, sans-serif;
      font-size:14px;
      margin:0 0 6px;
    }

    .taskArea{
      margin-top:8px;
      display:grid;
      gap:8px;
    }

    .taskRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:var(--radius2);
      border:1px solid rgba(120,84,160,0.12);
      background:rgba(255,255,255,0.55);
    }

    .taskRow input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
      accent-color:var(--pink);
      flex:0 0 auto;
    }

    .taskText{
      flex:1 1 auto;
      min-width:0;
      font-size:14px;
      line-height:1.3;
      word-break:break-word;
    }

    .taskText.done{
      text-decoration:line-through;
      color:rgba(34,17,47,0.55);
    }

    .queueLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    .closeLine{
      margin-top:12px;
      font-weight:800;
      font-size:15px;
    }

    @media (max-width:560px){
      .app{ padding:12px; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="top">
      <div>
        <h1>Daily Wind Up + Wind Down</h1>
        <div class="muted" id="todayLabel"></div>
      </div>

      <div class="dateRow">
        <span class="pill" id="prevWorkdayChip"></span>
        <button class="btnGhost" id="newDayBtn" type="button">New day</button>
      </div>
    </div>

    <!-- TODAY'S FOCUS -->
    <div class="card">
      <div class="headerRow">
        <div>
          <div class="sectionTitle">Todayâ€™s focus</div>
          <div class="muted" id="focusHint"></div>
        </div>
        <span class="pill" id="focusStatePill">Editing</span>
      </div>
      <input id="todaysFocus" placeholder="What is the main thing today" />
      <div class="muted" style="margin-top:8px;">
        Pulled from the previous workday if it existed. Keep it or change it.
      </div>
    </div>

    <!-- WIND UP -->
    <div class="card">
      <div class="headerRow">
        <div>
          <div class="sectionTitle">ðŸŒ… Wind Up</div>
          <div class="muted">Daily check in Â· 2â€“5 min</div>
        </div>
        <span class="pill" id="windUpStatePill">Editing</span>
      </div>

      <div class="lead">Alright. What are we working with today?</div>

      <div id="windUpEdit">
        <div class="subTitle">Pick the day type</div>
        <div class="muted">Pick up to two. One is totally fine.</div>
        <div class="chips" id="dayTypes"></div>

        <div class="subTitle">The Big 3</div>
        <div class="muted">Three tasks at a time. No overwhelm.</div>

        <div class="taskArea" id="taskArea"></div>

        <div class="queueLine">
          <div id="queueCount">Queue: 0</div>
          <div id="doneForNow" style="display:none;">Done for now ðŸ«¶</div>
        </div>

        <input id="newTask" placeholder="Add task" />

        <div class="subTitle">Energy + Flow</div>
        <input id="energyFeel" placeholder="How I want to feel while working" />
        <input id="flowHelp" placeholder="What will help today" />

        <div class="closeLine">Alright bestie, letâ€™s go âœ¨ðŸ’…</div>

        <div class="btnRow">
          <button class="btnPrimary" id="submitWindUp" type="button">Submit Wind Up</button>
        </div>
      </div>

      <div id="windUpView" style="display:none;">
        <div class="summary">
          <div class="summaryBlock">
            <div class="summaryTitle">Todayâ€™s focus</div>
            <div class="muted" id="viewFocus"></div>
          </div>

          <div class="summaryBlock">
            <div class="summaryTitle">Day type</div>
            <div id="viewDayTypes" class="muted"></div>
          </div>

          <div class="summaryBlock">
            <div class="summaryTitle">The Big 3</div>
            <div id="viewTasks"></div>
            <div class="muted" id="viewQueue"></div>
          </div>

          <div class="summaryBlock">
            <div class="summaryTitle">Energy + Flow</div>
            <div class="muted" id="viewEnergy"></div>
            <div class="muted" id="viewFlow"></div>
          </div>

          <div class="btnRow">
            <button class="btnGhost" id="editWindUp" type="button">Edit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WIND DOWN -->
    <div class="card">
      <div class="headerRow">
        <div>
          <div class="sectionTitle">ðŸŒ™ Wind Down</div>
          <div class="muted">End of day close out Â· 1â€“3 min</div>
        </div>
        <span class="pill" id="windDownStatePill">Editing</span>
      </div>

      <div id="windDownEdit">
        <div class="subTitle">Stuff I did today</div>
        <div class="muted">Anything counts. No explaining.</div>
        <textarea id="didToday" placeholder="Write freely. One line or a messy list is fine."></textarea>

        <div class="subTitle">One thing Iâ€™m proud of</div>
        <input id="proud" placeholder="One line only" />

        <div class="subTitle">One thing I learned (optional)</div>
        <input id="learned" placeholder="practical, emotional, pattern based" />

        <div class="subTitle">Tomorrowâ€™s main thing</div>
        <input id="tomorrowMain" placeholder="This becomes tomorrowâ€™s focus" />

        <div class="closeLine">Logging off. *sigh*</div>

        <div class="btnRow">
          <button class="btnPrimary" id="submitWindDown" type="button">Submit Wind Down</button>
        </div>
      </div>

      <div id="windDownView" style="display:none;">
        <div class="summary">
          <div class="summaryBlock">
            <div class="summaryTitle">Stuff I did today</div>
            <div class="muted" id="viewDid"></div>
          </div>

          <div class="summaryBlock">
            <div class="summaryTitle">One thing Iâ€™m proud of</div>
            <div class="muted" id="viewProud"></div>
          </div>

          <div class="summaryBlock" id="viewLearnedWrap">
            <div class="summaryTitle">One thing I learned</div>
            <div class="muted" id="viewLearned"></div>
          </div>

          <div class="summaryBlock">
            <div class="summaryTitle">Tomorrowâ€™s main thing</div>
            <div class="muted" id="viewTomorrow"></div>
          </div>

          <div class="btnRow">
            <button class="btnGhost" id="editWindDown" type="button">Edit</button>
          </div>
        </div>
      </div>
    </div>

    <div class="muted" style="padding:6px 2px;">
      Uses a 4am cutoff. Working late will not split your day at midnight.
      Saved on this device.
    </div>
  </div>

  <script>
    // ===== Workday logic =====
    // A "workday" is keyed by date, but the day changes at 4am (not midnight).
    const WORKDAY_CUTOFF_HOUR = 4;

    // ===== Storage schema =====
    // data = {
    //   days: {
    //     "YYYY-MM-DD": {
    //       date,
    //       dayTypes: string[],
    //       tasks: { id, text, done }[],
    //       energyFeel: string,
    //       flowHelp: string,
    //       didToday: string,
    //       proud: string,
    //       learned: string,
    //       tomorrowMain: string,
    //       todaysFocus: string,
    //       focusSourceDate: string,
    //       windUpSubmitted: boolean,
    //       windDownSubmitted: boolean
    //     }
    //   },
    //   ui: { currentDate: "YYYY-MM-DD" }
    // }
    const STORAGE_KEY = "daily_windup_winddown_v5_singlefile";

    const DAY_TYPES = [
      "Creative",
      "Research",
      "Structure + Organising",
      "Admin + Life Stuff",
      "Bare Minimum"
    ];

    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function addDays(iso, n){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate()+n);
      return isoDate(dt);
    }

    function getWorkdayISO(now){
      // If it's before cutoff hour, treat as previous day.
      const dt = new Date(now);
      if(dt.getHours() < WORKDAY_CUTOFF_HOUR){
        dt.setDate(dt.getDate() - 1);
      }
      return isoDate(dt);
    }

    function monthName(i){
      return ["January","February","March","April","May","June","July","August","September","October","November","December"][i];
    }

    function ordinal(n){
      const s = ["th","st","nd","rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function formatLong(iso){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, (m||1)-1, d||1);
      return `${ordinal(dt.getDate())} ${monthName(dt.getMonth())} ${dt.getFullYear()}`;
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 1600);
    }

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { days: {}, ui: { currentDate: "" } };
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed.days !== "object") return { days: {}, ui: { currentDate: "" } };
        if(!parsed.ui) parsed.ui = { currentDate: "" };
        return parsed;
      }catch(e){
        return { days: {}, ui: { currentDate: "" } };
      }
    }

    function saveData(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function emptyDay(date){
      return {
        date,
        dayTypes: [],
        tasks: [],
        energyFeel: "",
        flowHelp: "",
        didToday: "",
        proud: "",
        learned: "",
        tomorrowMain: "",
        todaysFocus: "",
        focusSourceDate: "",
        windUpSubmitted: false,
        windDownSubmitted: false
      };
    }

    function ensureDay(data, date){
      if(!data.days[date]){
        data.days[date] = emptyDay(date);
      }
      return data.days[date];
    }

    function cryptoRandomId(){
      if(window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(2);
        crypto.getRandomValues(a);
        return "t_" + a[0].toString(16) + a[1].toString(16);
      }
      return "t_" + Math.random().toString(16).slice(2);
    }

    function carryOverUnfinishedTasks(fromDay, toDay){
      const unfinished = (fromDay.tasks || []).filter(x => !x.done && String(x.text||"").trim().length);
      if(!unfinished.length) return;

      const existingTexts = new Set((toDay.tasks||[]).map(x => (x.text||"").trim()));
      const carried = unfinished
        .map(x => ({ id: cryptoRandomId(), text: x.text, done: false }))
        .filter(x => !existingTexts.has((x.text||"").trim()));

      if(carried.length){
        toDay.tasks = carried.concat(toDay.tasks || []);
      }
    }

    function pullFocus(fromDay, toDay, fromDate){
      const from = String(fromDay.tomorrowMain || "").trim();
      if(!from) return;

      const existing = String(toDay.todaysFocus || "").trim();

      // Only auto-fill if empty OR previously auto-filled from same source (meaning user didn't truly set it)
      if(!existing || toDay.focusSourceDate === fromDate){
        toDay.todaysFocus = from;
        toDay.focusSourceDate = fromDate;
      }
    }

    function currentBatchIndexes(tasks){
      const idxs = [];
      for(let i=0;i<tasks.length;i++){
        if(!tasks[i].done && String(tasks[i].text||"").trim().length){
          idxs.push(i);
          if(idxs.length === 3) break;
        }
      }
      return idxs;
    }

    function remainingCountAfterBatch(tasks){
      let left = 0;
      for(const t of tasks){
        if(!t.done && String(t.text||"").trim().length) left++;
      }
      return Math.max(0, left - 3);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function startNextWorkday(data, currentDate){
      const nextDate = addDays(currentDate, 1);

      const cur = ensureDay(data, currentDate);
      const nxt = emptyDay(nextDate);

      // Carry tasks + pull focus from current's tomorrowMain
      carryOverUnfinishedTasks(cur, nxt);
      pullFocus(cur, nxt, currentDate);

      data.days[nextDate] = nxt;
      data.ui.currentDate = nextDate;
      saveData(data);

      toast("New day ready âœ¨");
      render();
    }

    function syncCurrentDateToWorkday(data){
      const computed = getWorkdayISO(new Date());

      // If UI date is empty, set it
      if(!data.ui.currentDate){
        data.ui.currentDate = computed;
        return;
      }

      // If UI date is behind the computed workday (e.g. you reopened after cutoff), move it forward
      // We compare as strings because ISO sorts lexicographically.
      if(data.ui.currentDate < computed){
        data.ui.currentDate = computed;
      }
    }

    function render(){
      const data = loadData();
      syncCurrentDateToWorkday(data);

      const currentDate = data.ui.currentDate || getWorkdayISO(new Date());
      const prevWorkday = addDays(currentDate, -1);

      ensureDay(data, currentDate);
      ensureDay(data, prevWorkday);

      // Keep current day in sync with previous workday focus + tasks (only additive, never destructive)
      const cur = data.days[currentDate];
      const prev = data.days[prevWorkday];

      carryOverUnfinishedTasks(prev, cur);
      pullFocus(prev, cur, prevWorkday);

      saveData(data);

      // Header
      document.getElementById("todayLabel").textContent = `Workday: ${formatLong(currentDate)} (day flips at 4am)`;
      document.getElementById("prevWorkdayChip").textContent = `Previous: ${formatLong(prevWorkday)}`;

      // New day button
      document.getElementById("newDayBtn").onclick = () => {
        const d2 = loadData();
        syncCurrentDateToWorkday(d2);
        const cd = d2.ui.currentDate || getWorkdayISO(new Date());
        startNextWorkday(d2, cd);
      };

      // Focus input + lock
      const focusInput = document.getElementById("todaysFocus");
      const focusHint = document.getElementById("focusHint");
      const focusPill = document.getElementById("focusStatePill");

      const source = String(cur.focusSourceDate || "").trim();
      focusHint.textContent = source ? `Pulled from ${formatLong(source)}` : `Set it how you want`;

      focusInput.value = cur.todaysFocus || "";
      const focusLocked = !!cur.windUpSubmitted;
      focusInput.disabled = focusLocked;
      focusPill.textContent = focusLocked ? "Locked" : "Editing";

      focusInput.oninput = () => {
        // only editable when not locked
        if(cur.windUpSubmitted) return;
        cur.todaysFocus = focusInput.value;
        cur.focusSourceDate = ""; // user-owned now
        saveData(data);
      };

      // Day types
      const dayTypesWrap = document.getElementById("dayTypes");
      dayTypesWrap.innerHTML = "";
      DAY_TYPES.forEach(opt => {
        const chip = document.createElement("div");
        chip.className = "chip" + (cur.dayTypes.includes(opt) ? " active" : "");
        chip.textContent = opt;
        chip.onclick = () => {
          if(cur.windUpSubmitted) return;

          const has = cur.dayTypes.includes(opt);
          if(has){
            cur.dayTypes = cur.dayTypes.filter(x => x !== opt);
          } else {
            if(cur.dayTypes.length >= 2){
              toast("Two is enough bestie âœ¨");
              return;
            }
            cur.dayTypes = cur.dayTypes.concat(opt);
          }
          saveData(data);
          render();
        };
        dayTypesWrap.appendChild(chip);
      });

      // Tasks rendering (always checkable, even after submit, because tasks are real life)
      const taskArea = document.getElementById("taskArea");
      taskArea.innerHTML = "";

      const tasks = cur.tasks || [];
      const batchIdxs = currentBatchIndexes(tasks);

      const unfinishedCount = tasks.filter(t => !t.done && String(t.text||"").trim().length).length;
      document.getElementById("doneForNow").style.display = unfinishedCount === 0 ? "block" : "none";
      document.getElementById("queueCount").textContent = `Queue: ${remainingCountAfterBatch(tasks)} more`;

      batchIdxs.forEach(i => {
        const t = tasks[i];
        const row = document.createElement("div");
        row.className = "taskRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!t.done;

        const text = document.createElement("div");
        text.className = "taskText" + (t.done ? " done" : "");
        text.textContent = t.text;

        cb.onchange = () => {
          t.done = cb.checked;
          saveData(data);
          render();
        };

        row.appendChild(cb);
        row.appendChild(text);
        taskArea.appendChild(row);
      });

      // Add task input
      const newTask = document.getElementById("newTask");
      newTask.disabled = false;
      newTask.onkeydown = (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          const val = String(newTask.value||"").trim();
          if(!val) return;
          cur.tasks = (cur.tasks || []).concat({ id: cryptoRandomId(), text: val, done: false });
          newTask.value = "";
          saveData(data);
          render();
        }
      };

      // Energy fields (locked by windUpSubmitted; editable on Edit)
      const energyFeel = document.getElementById("energyFeel");
      const flowHelp = document.getElementById("flowHelp");
      energyFeel.value = cur.energyFeel || "";
      flowHelp.value = cur.flowHelp || "";

      energyFeel.disabled = !!cur.windUpSubmitted;
      flowHelp.disabled = !!cur.windUpSubmitted;

      energyFeel.oninput = () => {
        if(cur.windUpSubmitted) return;
        cur.energyFeel = energyFeel.value;
        saveData(data);
      };
      flowHelp.oninput = () => {
        if(cur.windUpSubmitted) return;
        cur.flowHelp = flowHelp.value;
        saveData(data);
      };

      // Wind Down fields (locked by windDownSubmitted)
      const didToday = document.getElementById("didToday");
      const proud = document.getElementById("proud");
      const learned = document.getElementById("learned");
      const tomorrowMain = document.getElementById("tomorrowMain");

      didToday.value = cur.didToday || "";
      proud.value = cur.proud || "";
      learned.value = cur.learned || "";
      tomorrowMain.value = cur.tomorrowMain || "";

      const wdLocked = !!cur.windDownSubmitted;
      didToday.disabled = wdLocked;
      proud.disabled = wdLocked;
      learned.disabled = wdLocked;
      tomorrowMain.disabled = wdLocked;

      didToday.oninput = () => { if(wdLocked) return; cur.didToday = didToday.value; saveData(data); };
      proud.oninput = () => { if(wdLocked) return; cur.proud = proud.value; saveData(data); };
      learned.oninput = () => { if(wdLocked) return; cur.learned = learned.value; saveData(data); };
      tomorrowMain.oninput = () => { if(wdLocked) return; cur.tomorrowMain = tomorrowMain.value; saveData(data); };

      applyWindUpMode(cur, data);
      applyWindDownMode(cur, data);
    }

    function applyWindUpMode(day, data){
      const edit = document.getElementById("windUpEdit");
      const view = document.getElementById("windUpView");
      const pill = document.getElementById("windUpStatePill");
      const focusInput = document.getElementById("todaysFocus");

      if(day.windUpSubmitted){
        edit.style.display = "none";
        view.style.display = "block";
        pill.textContent = "Submitted";

        document.getElementById("viewFocus").textContent =
          String(day.todaysFocus||"").trim() ? day.todaysFocus : "(empty)";

        const types = (day.dayTypes || []).join(", ");
        document.getElementById("viewDayTypes").textContent = types ? types : "None picked";

        const tasks = day.tasks || [];
        const batch = currentBatchIndexes(tasks).map(i => tasks[i]);
        const listHtml = batch.length
          ? batch.map(t => `<div class="muted">â€¢ ${escapeHtml(t.text)}</div>`).join("")
          : `<div class="muted">No tasks in the current batch</div>`;
        document.getElementById("viewTasks").innerHTML = listHtml;

        const remaining = tasks.filter(t => !t.done && String(t.text||"").trim().length).length;
        document.getElementById("viewQueue").textContent = remaining ? `Unfinished in queue: ${remaining}` : "All tasks done ðŸ«¶";

        document.getElementById("viewEnergy").textContent = (day.energyFeel || "").trim()
          ? `How I want to feel: ${day.energyFeel}`
          : "How I want to feel: (empty)";
        document.getElementById("viewFlow").textContent = (day.flowHelp || "").trim()
          ? `What will help: ${day.flowHelp}`
          : "What will help: (empty)";

        document.getElementById("editWindUp").onclick = () => {
          day.windUpSubmitted = false;
          saveData(data);
          render();
        };

      } else {
        edit.style.display = "block";
        view.style.display = "none";
        pill.textContent = "Editing";

        document.getElementById("submitWindUp").onclick = () => {
          day.windUpSubmitted = true;
          saveData(data);
          render();
        };
      }
    }

    function applyWindDownMode(day, data){
      const edit = document.getElementById("windDownEdit");
      const view = document.getElementById("windDownView");
      const pill = document.getElementById("windDownStatePill");

      if(day.windDownSubmitted){
        edit.style.display = "none";
        view.style.display = "block";
        pill.textContent = "Submitted";

        document.getElementById("viewDid").textContent = (day.didToday || "").trim() ? day.didToday : "(empty)";
        document.getElementById("viewProud").textContent = (day.proud || "").trim() ? day.proud : "(empty)";
        document.getElementById("viewTomorrow").textContent = (day.tomorrowMain || "").trim() ? day.tomorrowMain : "(empty)";

        const learnedTxt = (day.learned || "").trim();
        const wrap = document.getElementById("viewLearnedWrap");
        if(learnedTxt){
          wrap.style.display = "block";
          document.getElementById("viewLearned").textContent = learnedTxt;
        } else {
          wrap.style.display = "none";
        }

        document.getElementById("editWindDown").onclick = () => {
          day.windDownSubmitted = false;
          saveData(data);
          render();
        };

      } else {
        edit.style.display = "block";
        view.style.display = "none";
        pill.textContent = "Editing";

        document.getElementById("submitWindDown").onclick = () => {
          day.windDownSubmitted = true;
          saveData(data);
          render();
        };
      }
    }

    render();
  </script>
</body>
</html>
